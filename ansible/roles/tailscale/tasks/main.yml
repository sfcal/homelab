---
# --- Install Tailscale from official repo ---
- name: Install prerequisites.
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
    state: present

- name: Add Tailscale signing key.
  ansible.builtin.get_url:
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: "0644"

- name: Add Tailscale apt repository.
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg]
      https://pkgs.tailscale.com/stable/ubuntu noble main
    filename: tailscale
    state: present
    update_cache: true

- name: Install Tailscale.
  ansible.builtin.apt:
    name: tailscale
    state: present

# --- Enable IP forwarding (required for subnet router) ---
- name: Enable IPv4 forwarding.
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: true
    state: present
    reload: true
  when: tailscale_mode == "subnet_router"

- name: Enable IPv6 forwarding.
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    sysctl_set: true
    state: present
    reload: true
  when: tailscale_mode == "subnet_router"

# --- Build tailscale up command based on mode ---
- name: Build tailscale up command (subnet_router).
  ansible.builtin.set_fact:
    _tailscale_up_cmd: >-
      tailscale up
      --authkey={{ tailscale_auth_key }}
      --advertise-routes={{ tailscale_advertise_routes | join(',') }}
      --accept-dns={{ tailscale_accept_dns | lower }}
      --hostname={{ tailscale_hostname }}
      --reset
  when: tailscale_mode == "subnet_router"

- name: Build tailscale up command (client).
  ansible.builtin.set_fact:
    _tailscale_up_cmd: >-
      tailscale up
      --authkey={{ tailscale_auth_key }}
      {% if tailscale_accept_routes %}--accept-routes{% endif %}
      --hostname={{ tailscale_hostname }}
      --reset
  when: tailscale_mode == "client"

# --- Start and authenticate ---
- name: Ensure tailscaled is enabled and running.
  ansible.builtin.service:
    name: tailscaled
    state: started
    enabled: true

- name: Check current Tailscale status.
  ansible.builtin.command: tailscale status --json
  register: ts_status
  changed_when: false
  failed_when: false

- name: Parse Tailscale backend state.
  ansible.builtin.set_fact:
    ts_backend_state: "{{ (ts_status.stdout | from_json).BackendState | default('NoState') }}"
  when: ts_status.rc == 0

- name: Bring Tailscale up.
  ansible.builtin.command: "{{ _tailscale_up_cmd }}"
  register: ts_up
  changed_when: "'Success' in ts_up.stdout or ts_up.rc == 0"
  when: >-
    ts_status.rc != 0
    or ts_backend_state != 'Running'
    or tailscale_force_reauth | default(false)

- name: Display Tailscale status.
  ansible.builtin.command: tailscale status
  register: ts_final_status
  changed_when: false

- name: Show Tailscale status.
  ansible.builtin.debug:
    msg: "{{ ts_final_status.stdout_lines }}"
