---
- name: Install BIND9.
  ansible.builtin.apt:
    name:
      - bind9
      - bind9utils
      - bind9-doc
    state: present

- name: Set timezone.
  community.general.timezone:
    name: America/New_York

- name: Deploy BIND9 named.conf configuration.
  ansible.builtin.template:
    src: "templates/named.conf.j2"
    dest: "/etc/bind/named.conf"
    owner: bind
    group: bind
    mode: 0644
  notify:
    - Check bind9 config
    - Restart bind9

- name: Deploy BIND9 zone files (primary only).
  ansible.builtin.template:
    src: "templates/{{ item }}.j2"
    dest: "/etc/bind/{{ item }}"
    owner: bind
    group: bind
    mode: 0644
  notify:
    - Check bind9 config
    - Reload bind9
  with_items:
    - local-sfc-al.zone
    - sfc-al.zone
    - 0.1.10.in-addr.arpa.zone
  when: (dns_servers | selectattr('ip', 'equalto', ansible_default_ipv4.address) | first).role == 'primary'

- name: Ensure BIND9 is running and enabled.
  ansible.builtin.service:
    name: bind9
    state: started
    enabled: true